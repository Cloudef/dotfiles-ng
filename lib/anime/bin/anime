#!/bin/bash
# watch anime
#
# to save shell history do alias
# in zsh:
#     alias anime='print -s "$(/path/to/this/script)"'
# in bash:
#     alias anime='history -s "$(/path/to/this/script)"'
#

source "$_LIBANIME_ROOT/libanime"

main() {
   local ahist=
   [[ "$1" == "-r" ]] && ahist=1

   # init
   _anime_init "$@"; shift $?
   [[ $ahist -eq 1 ]] && ahist="-r $_ANIME_ROOT "

   # locate and filter
   local match1="$(_anime_get_f "$_ANIME_WATCHING" "$@")"
   local match2="$(_anime_get_f "$_ANIME_WATCHED" "$@")"

   # join matches
   [[ -n "$match1" ]] && match="$match1"
   [[ -n "$match2" ]] && {
      [[ -n "$match" ]] && match="$match\n"
      match="$match$match2"
   }

   # output to dmenu
   [[ $(echo -e "$match" | wc -l) -gt 1 ]] && match="$(echo -e "$match" | dmenu -i -l 20 -p "anime")"
   [[ -n "$match" ]] || return 1

   # create full path
   file="$(_anime_lookup_f "$_ANIME_WATCHING" "$match")"
   [[ -f "$file" ]] || file="$(_anime_lookup_f "$_ANIME_WATCHED" "$match")"
   [[ -f "$file" ]] || return 1;

   # append to history
   [[ "$ahist$match" != "$(tail -n1 "$_ANIME_HISTORY")" ]] && echo "$ahist$match" >> "$_ANIME_HISTORY"

   # play
   echo "playing: $file"
   mpv "$file" 1> /dev/null
}

if [[ "$1" == "l" ]]; then
   main $(tail -n1 "$_ANIME_HISTORY" | sed 's/[0-9]//g')
else
   main "$@"
fi
