#!/bin/sh
# watch anime
#
# to save history do alias
# in zsh:
#     alias anime='print -s "$(_anime)"'
# in bash:
#     alias anime='history -s "$(_anime)"'
#
# otherwise just alias to _anime or rename
# this shell script.

source "$_LIBANIME_ROOT/libanime"

main() {
   local ahist=
   [[ "$1" == "-r" ]] && ahist=1

   # init
   _anime_init "$@"; shift $?
   [[ $ahist -eq 1 ]] && ahist="-r \"$_ANIME_ROOT\" " ||
      ahist=""

   # locate and filter
   local match1="$(_anime_get_f "$_ANIME_WATCHING" "$@")"
   local match2="$(_anime_get_f "$_ANIME_WATCHED" "$@")"

   # join matches
   [[ -n "$match1" ]] && match="$match1"
   [[ -n "$match2" ]] && {
      [[ -n "$match" ]] && match="$match\n"
      match="$match$match2"
   }

   # output to dmenu
   if [[ $(echo -e "$match" | wc -l) -gt 1 ]]; then
      match="$(echo -e "$match" | dmenu -i -l 20 -p "anime")"
      orig="" # save the selected to history
   fi
   [[ -n "$match" ]] || return 1

   # create full path
   file="$(_anime_lookup_f "$_ANIME_WATCHING" "$match")"
   [[ -f "$file" ]] || file="$(_anime_lookup_f "$_ANIME_WATCHED" "$match")"
   [[ -f "$file" ]] || return 1;

   # append to history
   [[ -n "$orig" ]]
   [[ -n "$orig" ]] &&
      { echo "$ahist$orig"  >> "$_ANIME_HISTORY"; } ||
      { echo "$ahist$match" >> "$_ANIME_HISTORY"; }

   # play
   echo "playing: $file"
   mplayer -really-quiet "$file" &> /dev/null
}
main "$@"
exit $?
